{% extends "base.html" %}

{% block title %}Past Worksheets{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Past Worksheets for {{ child.name }}</h2>
        <button onclick="deleteSelected()" class="btn btn-danger" id="bulk-delete" style="display: none;">
            Delete Selected
        </button>
    </div>

    {% if past_scores %}
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Progress</h5>
            <div id="sparkline"></div>
        </div>
    </div>
    {% endif %}

    <table class="table">
        <thead>
            <tr>
                <th>
                    <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                </th>
                <th>Serial #</th>
                <th>Date</th>
                <th>Problems</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for worksheet in worksheets %}
            <tr>
                <td>
                    <input type="checkbox" class="worksheet-select" data-id="{{ worksheet.id }}">
                </td>
                <td>{{ worksheet.serial_number }}</td>
                <td>{{ worksheet.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ worksheet.problem_count }}</td>
                <td>
                    {% if worksheet.incorrect_problems is not none %}
                        {% set total = worksheet.problem_count %}
                        {% set incorrect = worksheet.incorrect_problems|length %}
                        {% set score = ((total - incorrect) / total * 100)|round|int %}
                        <span class="badge {% if score >= 80 %}bg-success{% elif score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                            {{ score }}% ({{ incorrect }} wrong)
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">Not Graded</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('web.view_worksheet', worksheet_id=worksheet.id) }}" class="btn btn-sm btn-primary">View</a>
                    <a href="{{ url_for('web.grade_worksheet', worksheet_id=worksheet.id) }}" class="btn btn-sm btn-info">Grade</a>
                    <a href="{{ url_for('web.view_worksheet', worksheet_id=worksheet.id, print=1) }}" class="btn btn-sm btn-secondary">Print</a>
                    <button onclick="deleteWorksheet('{{ worksheet.id }}')" class="btn btn-sm btn-danger">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if past_scores %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var options = {
        series: [{
            data: {{ past_scores|tojson }}
        }],
        chart: {
            type: 'line',
            height: 100,
            sparkline: {
                enabled: true
            }
        },
        stroke: {
            curve: 'smooth',
            width: 2
        },
        tooltip: {
            fixed: {
                enabled: true
            },
            x: {
                show: true,
                formatter: function(value, opts) {
                    return {{ past_dates|tojson }}[opts.dataPointIndex];
                }
            },
            y: {
                formatter: function(value) {
                    return value.toFixed(1) + '%';
                }
            }
        },
        colors: ['#2196F3']
    };

    var chart = new ApexCharts(document.querySelector("#sparkline"), options);
    chart.render();
});
</script>
{% endif %}

{% block extra_js %}
<script>
function toggleSelectAll(checkbox) {
    const worksheetCheckboxes = document.querySelectorAll('.worksheet-select');
    worksheetCheckboxes.forEach(cb => cb.checked = checkbox.checked);
    updateBulkDeleteButton();
}

function updateBulkDeleteButton() {
    const selectedCount = document.querySelectorAll('.worksheet-select:checked').length;
    const bulkDeleteBtn = document.getElementById('bulk-delete');
    bulkDeleteBtn.style.display = selectedCount > 0 ? 'block' : 'none';
    bulkDeleteBtn.textContent = `Delete Selected (${selectedCount})`;
}

// Add change event listeners to all checkboxes
document.querySelectorAll('.worksheet-select').forEach(checkbox => {
    checkbox.addEventListener('change', updateBulkDeleteButton);
});

async function deleteWorksheet(worksheetId) {
    if (!confirm('Are you sure you want to delete this worksheet?')) {
        return;
    }

    try {
        const response = await fetch(`{{ url_for('web.delete_worksheet', worksheet_id='') }}${worksheetId}`, {
            method: 'POST'
        });

        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error deleting worksheet: ' + result.error);
        }
    } catch (error) {
        alert('Error deleting worksheet: ' + error.message);
    }
}

async function deleteSelected() {
    const selectedIds = Array.from(document.querySelectorAll('.worksheet-select:checked'))
        .map(cb => cb.dataset.id);

    if (selectedIds.length === 0) {
        return;
    }

    if (!confirm(`Are you sure you want to delete ${selectedIds.length} worksheets?`)) {
        return;
    }

    try {
        const response = await fetch('{{ url_for('web.bulk_delete_worksheets') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                worksheet_ids: selectedIds
            })
        });

        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error deleting worksheets: ' + result.error);
        }
    } catch (error) {
        alert('Error deleting worksheets: ' + error.message);
    }
}
</script>
{% endblock %}
{% endblock %} 